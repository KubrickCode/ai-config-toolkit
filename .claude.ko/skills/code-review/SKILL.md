---
name: code-review
description: 현재 git 변경사항 또는 최신 커밋을 code-reviewer와 architect-reviewer 에이전트로 리뷰
allowed-tools: Bash(git status:*), Bash(git diff:*), Bash(git log:*), Bash(git show:*), Task
disable-model-invocation: true
---

# 코드 리뷰 커맨드

## 목적

현재 변경사항 또는 최신 커밋에 대한 종합적인 코드 리뷰 수행. 자동으로 호출되는 에이전트:

- **code-reviewer 에이전트**: 항상 (코드 품질, 보안, 유지보수성)
- **architect-reviewer 에이전트**: 조건부 (아키텍처 영향 평가)

---

## 워크플로우

### 1. 리뷰 대상 결정

**커밋되지 않은 변경사항 확인:**

```bash
git status --porcelain
```

**결정:**

- 변경사항 있음: `git diff`로 미커밋 변경사항 리뷰
- 변경사항 없음: `git log -1` 및 `git show HEAD`로 최신 커밋 리뷰

### 2. 변경 범위 분석

**git 출력에서 메트릭 추출:**

수치화:

- 변경된 파일 수
- 추가/삭제된 라인 수
- 영향받는 디렉토리 수
- 신규 파일 vs 수정 파일

탐지:

- 데이터베이스 마이그레이션 파일 (`migrations/`, `schema.prisma`, `*.sql`)
- API 계약 파일 (`*.graphql`, `openapi.yaml`, API 라우트 파일)
- 설정 파일 (`package.json`, `go.mod`, `docker-compose.yml`)
- 신규 디렉토리 또는 모듈

### 3. code-reviewer 에이전트 호출

**항상 Task 도구로 subagent_type: "code-reviewer" 사용하여 실행:**

```
현재 변경사항에 대한 종합적인 코드 리뷰 수행.

집중 영역:
- 코드 품질: 가독성, 네이밍, 구조
- 보안: 노출된 시크릿, 입력 검증, 취약점 패턴
- 에러 처리: 엣지 케이스, 에러 메시지, 복구
- 성능: 명백한 병목, 비효율적 패턴
- 테스트: 중요 경로 커버리지
- 코딩 가이드라인 준수

피드백을 다음으로 구성:
- 치명적 이슈 (머지 전 반드시 수정)
- 경고 (수정 권장)
- 제안 (개선 고려)
```

### 4. 조건부 architect-reviewer 호출

**범위 분류 기준** (해당 기준마다 점수 부여):

| 기준                | 임계값                                       | 점수 |
| ------------------- | -------------------------------------------- | ---- |
| 변경된 파일 수      | ≥ 8개 파일                                   | +1   |
| 변경된 라인 수      | ≥ 300줄                                      | +1   |
| 영향받는 디렉토리   | ≥ 3개 디렉토리                               | +1   |
| 새 모듈/패키지      | 3개 이상 파일이 있는 새 디렉토리             | +1   |
| API 계약 변경       | 수정: schema/, .graphql, api/, 라우트 파일   | +1   |
| 데이터베이스 스키마 | 수정: migrations, 스키마 파일, ORM 모델      | +1   |
| 설정/인프라         | 수정: docker-compose, Dockerfile, K8s, CI/CD | +1   |
| 의존성 변경         | 수정: package.json, go.mod, requirements.txt | +1   |

**결정**:

- **점수 < 3** → `code-reviewer`만 호출
- **점수 ≥ 3** → `code-reviewer`와 `architect-reviewer` 모두 호출

---

## 출력 형식

**통합 리뷰 요약 생성:**

```markdown
# 코드 리뷰 보고서

**생성일**: {타임스탬프}
**범위**: {미커밋 변경사항 / 최신 커밋: {해시}}
**변경된 파일 수**: {개수}
**호출된 리뷰어**: code-reviewer{, 해당 시 architect-reviewer}

---

## 📊 변경사항 요약

- **라인**: +{추가} -{삭제}
- **파일**: {개수} ({신규} 신규, {수정} 수정)
- **디렉토리**: {영향받는 디렉토리}

---

## 🔍 코드 리뷰어 피드백

{code-reviewer 에이전트의 통합 출력}

---

## 🏗️ 아키텍처 리뷰어 피드백

{호출된 경우, architect-reviewer 에이전트의 통합 출력}
{호출되지 않은 경우: "이 변경 범위에서는 아키텍처 리뷰가 필요하지 않습니다"}

---

## ✅ 리뷰 체크리스트

### 치명적 (반드시 수정)

- [ ] {이슈 1}
- [ ] {이슈 2}

### 우선순위 높음 (수정 권장)

- [ ] {이슈 3}

### 제안 (고려)

- [ ] {개선 1}
```

---

## 중요 사항

- **코드 직접 수정 금지** - 이 커맨드는 리뷰만 수행
- **에이전트 자율성**: code-reviewer와 architect-reviewer는 필요에 따라 파일 읽기, 테스트 실행, 의존성 분석 가능
- **점진적 리뷰**: 대규모 변경(20개 이상 파일)의 경우, 에이전트가 영향도 높은 영역을 우선 집중
- **Git 안전성**: 모든 git 명령은 읽기 전용 (status, diff, log, show)
